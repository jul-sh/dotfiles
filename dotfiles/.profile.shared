# Shell sourcing order:
#   .bash_profile / .zprofile → .profile.shared (this file) → sets PATH, sources Nix
#   .bashrc                   → .bashrc.shared              → launches zsh
#   .zshrc                    → .zshrc.shared               → actual shell config

# Source Nix multi-user profile if it exists
if [ -f "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh" ]; then
  . "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
fi
# Source Nix single-user profile if it exists
if [ -f "$HOME/.nix-profile/etc/profile.d/nix.sh" ]; then
  . "$HOME/.nix-profile/etc/profile.d/nix.sh"
fi

# ai <task> - Quick AI helper (auto-accepts, exits when done)
# ai -c     - Continue last conversation in interactive mode
# Use noglob to allow unquoted special chars: ai kill the process on port 6666
alias ai='noglob _ai'
_ai_spinner() {
    local BR='\033[91m' BY='\033[93m' BG='\033[92m' BC='\033[96m' BB='\033[94m' BM='\033[95m'
    local BOLD='\033[1m' DIM='\033[2m' RST='\033[0m'
    local colors=("$BR" "$BY" "$BG" "$BC" "$BB" "$BM")
    local faces=("(◕‿◕✿)" "(◕ᴗ◕✿)" "(◕ω◕✿)" "(◕◡◕✿)" "(◕‿◕❀)" "(◕ᴗ◕❀)")
    local left=("✨ ･ﾟ✧" " ✧･ﾟ✨" "･ﾟ✨ ✧" "ﾟ✧ ✨･" "✧ ･ﾟ✨" " ✨･ﾟ✧")
    local right=("✧ﾟ･ ✨" "✨ ✧ﾟ･" " ･✧ﾟ✨" "ﾟ✨ ･✧" "･ ✨✧ﾟ" "✧ ﾟ･✨")
    local spin=("⣾" "⣽" "⣻" "⢿" "⡿" "⣟" "⣯" "⣷")
    local f=0
    printf '\033[?25l' >&2
    while true; do
        printf '\r\033[K  %b%s%b %b%b%s%b %b%s%b %b%s%b' \
            "${colors[$((f % 6))]}" "${left[$((f % 6))]}" "$RST" \
            "${colors[$(((f + 2) % 6))]}" "$BOLD" "${faces[$((f % 6))]}" "$RST" \
            "${colors[$(((f + 4) % 6))]}" "${right[$((f % 6))]}" "$RST" \
            "$DIM" "${spin[$((f % 8))]}" "$RST" >&2
        sleep 0.08
        f=$((f + 1))
    done
}
_ai() {
    if [ "$1" = "-c" ]; then
        printf "\033[36m✨ Continuing last conversation...\033[0m\n" >&2
        if command -v claude &>/dev/null; then
            claude --dangerously-skip-permissions -c
        elif command -v gemini &>/dev/null; then
            gemini
        else
            echo "error: neither claude nor gemini CLI found" >&2
            return 1
        fi
        return
    fi

    _ai_spinner &
    local spinner_pid=$!
    trap "kill $spinner_pid 2>/dev/null; printf '\033[?25h\r\033[K' >&2" EXIT

    if command -v claude &>/dev/null; then
        claude -p --model haiku --dangerously-skip-permissions --max-turns 10 \
            --append-system-prompt "Be concise. Do the task, don't ask follow-up questions." "$*"
    elif command -v gemini &>/dev/null; then
        gemini --yolo -p "$*"
    else
        echo "error: neither claude nor gemini CLI found" >&2
        return 1
    fi

    kill $spinner_pid 2>/dev/null
    printf '\033[?25h\r\033[K' >&2
    trap - EXIT
}

# Add user-level package manager binaries to PATH
# These directories allow installing tools without sudo/Nix for quick iteration

# Cargo: cargo install <crate>
export PATH="$HOME/.cargo/bin:$PATH"

# UV: uv tool install <package> (Python tools)
export PATH="$HOME/.local/bin:$PATH"

# Go: go install <package>
export PATH="$HOME/go/bin:$PATH"

# NPM: npm install -g <package> (when configured with prefix=~/.npm-global)
export PATH="$HOME/.npm-global/bin:$PATH"

# System binaries (lower priority than Nix packages)
export PATH="$PATH:/usr/local/bin"

if command -v python3 &> /dev/null; then
  # Set these if python3 is available
  export PATH="$(python3 -m site --user-base)/bin:$PATH"
  alias python='python3'
fi


# attach [name] - Attach to or create a zellij session
#   No args: uses <dirname>_<hash> based on $PWD
#   --list:  show existing sessions
attach() {
    if [ "$1" = "--list" ] || [ "$1" = "-l" ]; then
        zellij list-sessions 2>/dev/null || echo "No sessions"
        return
    fi

    if [ -n "$1" ]; then
        TARGET="$1"
    else
        DIR_NAME=$(basename "$PWD")
        PATH_HASH=$(echo "$PWD" | md5sum | cut -c1-4)
        TARGET="${DIR_NAME}_${PATH_HASH}"
    fi

    SESSIONS=$(zellij list-sessions 2>/dev/null | perl -pe 's/\e\[\d*(;\d+)*m//g')
    FUZZY_MATCH=$(echo "$SESSIONS" | grep "^${TARGET}_" | head -n 1 | awk '{print $1}')

    if [ -n "$FUZZY_MATCH" ]; then
        echo "Attaching to: $FUZZY_MATCH"
        zellij attach "$FUZZY_MATCH"
    else
        zellij attach -c "$TARGET"
    fi
}

# Source utils if they exist
if [ -f "$HOME/.utils.sh" ]; then
  source "$HOME/.utils.sh"
fi

# Check for dotfile updates
if [ -f "$HOME/.dotfiles_update.sh" ]; then
  source "$HOME/.dotfiles_update.sh"
fi
